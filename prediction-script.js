const classroom = document.getElementById('classroom');
const log = document.getElementById('log');
const rows = 5;
const cols = 5;

// Generate 25 seats with "Coordinate" data
function init() {
    classroom.innerHTML = '';
    for (let i = 0; i < rows * cols; i++) {
        const seat = document.createElement('div');
        seat.className = 'seat';
        seat.innerText = `[${Math.floor(i/5)}, ${i%5}]`;
        classroom.appendChild(seat);
    }
}

async function startPrediction() {
    const seats = document.querySelectorAll('.seat');
    const order = Array.from({length: 25}, (_, i) => i);

    // WEIGHTED SORT: Students prefer high row indices (back) 
    // and middle column indices (better view angle)
    order.sort((a, b) => {
        const rowA = Math.floor(a / 5);
        const rowB = Math.floor(b / 5);
        const colA = a % 5;
        const colB = b % 5;

        const scoreA = (rowA * 10) + (2 - Math.abs(2 - colA)); 
        const scoreB = (rowB * 10) + (2 - Math.abs(2 - colB));

        return (scoreB + Math.random() * 5) - (scoreA + Math.random() * 5);
    });

    for (const index of order) {
        await new Promise(r => setTimeout(r, 400));
        seats[index].classList.add('active');
        addToLog(`KNN: User clustered at Node ${seats[index].innerText}`);
    }
}

function addToLog(msg) {
    const li = document.createElement('li');
    li.innerText = `> ${msg}`;
    log.prepend(li);
}

function resetSim() {
    init();
    log.innerHTML = '<li>System reset...</li>';
}

init();
function downloadReport() {
    // 1. Collect all the text from our log
    const logItems = document.querySelectorAll('#log li');
    let reportContent = "ML OCCUPANCY PREDICTOR - DATA EXPORT\n";
    reportContent += "Generated by: ECE-AIML Pattern Lab\n";
    reportContent += "------------------------------------\n\n";
    
    logItems.forEach(item => {
        reportContent += item.innerText + "\n";
    });

    // 2. Create the file object
    const blob = new Blob([reportContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    
    // 3. Create a hidden link and "click" it to start download
    const a = document.createElement('a');
    a.href = url;
    a.download = `Occupancy_Report_${new Date().getTime()}.txt`;
    document.body.appendChild(a);
    a.click();
    
    // Cleanup
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Update your startPrediction function to enable the button when finished
async function startPrediction() {
    document.getElementById('download-btn').disabled = true; // Disable while running
    const seats = document.querySelectorAll('.seat');
    const order = Array.from({length: 25}, (_, i) => i);

    order.sort((a, b) => {
        const rowA = Math.floor(a / 5);
        const rowB = Math.floor(b / 5);
        const colA = a % 5;
        const colB = b % 5;
        const scoreA = (rowA * 10) + (2 - Math.abs(2 - colA)); 
        const scoreB = (rowB * 10) + (2 - Math.abs(2 - colB));
        return (scoreB + Math.random() * 5) - (scoreA + Math.random() * 5);
    });

    for (const index of order) {
        await new Promise(r => setTimeout(r, 400));
        seats[index].classList.add('active');
        addToLog(`KNN: User clustered at Node ${seats[index].innerText}`);
    }

    // Enable download button when done!
    document.getElementById('download-btn').disabled = false;
    document.getElementById('download-btn').style.opacity = "1";
}